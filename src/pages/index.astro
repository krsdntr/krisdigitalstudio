---
import Layout from '../layouts/Layout.astro';
import HeaderClient from "../components/HeaderClient.jsx";
import Hero from "../components/Hero.jsx";
import Problem from "../components/Problem.jsx";
import Process from "../components/Process.jsx";
import Urgency from "../components/Urgency.jsx";
import Pricing from "../components/Pricing.jsx";
import FAQ from "../components/FAQ.jsx";
import Profile from "../components/Profile.jsx";
import CallToAction from "../components/CallToAction.jsx";
import Footer from "../components/Footer.jsx";
import Projects from "../components/Projects.jsx";
import Products from "../components/Products.jsx";
import Articles from "../components/Articles.jsx";
import TextMedia from "../components/TextMedia.jsx";
import Stats from "../components/Stats.jsx";

import { getLandingBlocks, getSystemStyles, getProjects, getDigitalProducts, getBlogPosts } from "../lib/notion.js";

// Fetch dynamic sections driven by Notion
const [blocks, styles, allProjects, allProducts, allPosts] = await Promise.all([
    getLandingBlocks(),
    getSystemStyles(),
    getProjects(),
    getDigitalProducts(),
    getBlogPosts()
]);

const projects = allProjects?.items?.slice(0, 3) || [];
const products = allProducts?.items?.slice(0, 3) || [];
const posts = allPosts?.items?.slice(0, 3) || [];

const projectsCount = allProjects?.items?.length || 0;
const productsCount = allProducts?.items?.length || 0;
const articlesCount = allPosts?.items?.length || 0;
---

<Layout>
    <div class="min-h-screen bg-transparent">
        <HeaderClient styles={styles} client:load />

        {blocks.length === 0 ? (
            <>
                <Hero client:load />
                <Problem />
                <Process />
                <!-- Static blocks do not need client directives -->
                <Projects projects={projects} />
                <Urgency />
                <Pricing client:visible />
                <FAQ client:visible />
                <Profile client:visible />
                <CallToAction client:visible />
            </>
        ) : (
            blocks.map((block) => {
                switch(block.componentName) {
                    case 'Hero': return <Hero blockData={block} client:load />;
                    case 'Problem': return <Problem blockData={block} />;
                    case 'Process': return <Process blockData={block} />;
                    case 'Urgency': return <Urgency blockData={block} />;
                    case 'Pricing': return <Pricing blockData={block} client:visible />;
                    case 'FAQ': return <FAQ blockData={block} client:visible />;
                    case 'Profile': return <Profile blockData={block} client:visible />;
                    case 'CallToAction': return <CallToAction blockData={block} client:visible />;
                    case 'Projects': return <Projects blockData={block} projects={projects} />;
                    case 'Products': return <Products blockData={block} products={products} />;
                    case 'Articles': return <Articles blockData={block} posts={posts} />;
                    case 'TextMedia': return <TextMedia blockData={block} />;
                    case 'Stats': return <Stats blockData={block} projectsCount={projectsCount} productsCount={productsCount} articlesCount={articlesCount} />;
                    default: return null;
                }
            })
        )}

        <Footer styles={styles} />
    </div>
</Layout>
